<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIRA Test Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">JIRA Test Generator</h1>
            <p class="text-lg text-gray-600">Generate API test projects from JIRA acceptance criteria</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- JIRA Tickets Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Select JIRA Ticket</h2>
                
                <div class="mb-4">
                    <button id="loadTicketsBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Load JIRA Tickets
                    </button>
                </div>

                <div id="ticketsContainer" class="hidden">
                    <div class="grid gap-4" id="ticketsList">
                        <!-- Tickets will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Selected Ticket Details -->
            <div id="selectedTicketSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Selected Ticket Details</h2>
                <div id="ticketDetails">
                    <!-- Ticket details will be shown here -->
                </div>
            </div>

            <!-- Test Generation Section -->
            <div id="testGenerationSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Generate Test Project</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Language:</label>
                    <select id="languageSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="java">Java (Spring Boot + RestAssured)</option>
                        <option value="python">Python (pytest + requests)</option>
                    </select>
                </div>

                <!-- Added test scenario selection options -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Scenarios to Include:</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="positiveTests" checked class="mr-2 text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">Positive Test Cases (Happy Path)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="negativeTests" checked class="mr-2 text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">Negative Test Cases (Error Scenarios)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="edgeCases" checked class="mr-2 text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">Edge Cases & Boundary Conditions</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="integrationTests" checked class="mr-2 text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">Integration Tests</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="dataValidation" checked class="mr-2 text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">Data Validation Tests</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button id="generateBtn" class="bg-success text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                        Generate Test Project
                    </button>
                    <button id="downloadBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors hidden">
                        Download ZIP
                    </button>
                </div>
            </div>

            <!-- Generated Project Preview -->
            <div id="projectPreviewSection" class="bg-white rounded-lg shadow-md p-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Generated Project Preview</h2>
                <div id="projectPreview">
                    <!-- Generated project files will be shown here -->
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                    <p class="text-gray-700">Generating test project...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedTicket = null;
        let generatedProject = null;

        // Load JIRA tickets
        document.getElementById('loadTicketsBtn').addEventListener('click', async () => {
            console.log('[v0] JIRA Connect button clicked');
            try {
                console.log('[v0] Making API call to /api/jira/tickets');
                const response = await fetch('/api/jira/tickets');
                console.log('[v0] API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[v0] JIRA API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('[v0] API Response data:', data);
                
                // Handle both direct array and wrapped response
                const tickets = Array.isArray(data) ? data : (data.tickets || data);
                
                if (!Array.isArray(tickets)) {
                    console.error('[v0] Invalid response format:', data);
                    throw new Error('Invalid response format: expected array of tickets');
                }
                
                console.log('[v0] Successfully loaded', tickets.length, 'tickets from JIRA');
                displayTickets(tickets);
                document.getElementById('ticketsContainer').classList.remove('hidden');
            } catch (error) {
                console.error('[v0] Error loading tickets:', error);
                alert(`Error loading JIRA tickets: ${error.message || error}`);
            }
        });

        // Display tickets
        function displayTickets(tickets) {
            const ticketsList = document.getElementById('ticketsList');
            ticketsList.innerHTML = '';

            tickets.forEach(ticket => {
                const ticketCard = document.createElement('div');
                ticketCard.className = 'border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors';
                ticketCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-lg text-gray-800">${ticket.key}</h3>
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(ticket.status)}">${ticket.status}</span>
                    </div>
                    <p class="text-gray-600 mb-2">${ticket.summary}</p>
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>Priority: ${ticket.priority}</span>
                        <span>Assignee: ${ticket.assignee}</span>
                    </div>
                `;
                
                ticketCard.addEventListener('click', () => selectTicket(ticket));
                ticketsList.appendChild(ticketCard);
            });
        }

        // Get status color
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'done': return 'bg-green-100 text-green-800';
                case 'in progress': return 'bg-blue-100 text-blue-800';
                case 'to do': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Select ticket
        function selectTicket(ticket) {
            selectedTicket = ticket;
            
            // Update selected ticket display
            const ticketDetails = document.getElementById('ticketDetails');
            ticketDetails.innerHTML = `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-semibold text-xl text-gray-800">${ticket.key}</h3>
                        <span class="px-3 py-1 text-sm rounded-full ${getStatusColor(ticket.status)}">${ticket.status}</span>
                    </div>
                    <p class="text-gray-700 mb-4">${ticket.summary}</p>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <h4 class="font-medium text-gray-800 mb-2">Acceptance Criteria:</h4>
                        <pre class="text-sm text-gray-600 whitespace-pre-wrap">${ticket.description}</pre>
                    </div>
                </div>
            `;
            
            // Show sections
            document.getElementById('selectedTicketSection').classList.remove('hidden');
            document.getElementById('testGenerationSection').classList.remove('hidden');
            
            // Highlight selected ticket
            document.querySelectorAll('#ticketsList > div').forEach(card => {
                card.classList.remove('bg-blue-50', 'border-blue-300');
            });
            event.currentTarget.classList.add('bg-blue-50', 'border-blue-300');
        }

        // Generate test project
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (!selectedTicket) {
                alert('Please select a JIRA ticket first');
                return;
            }

            const language = document.getElementById('languageSelect').value;
            
            const testScenarios = {
                positiveTests: document.getElementById('positiveTests').checked,
                negativeTests: document.getElementById('negativeTests').checked,
                edgeCases: document.getElementById('edgeCases').checked,
                integrationTests: document.getElementById('integrationTests').checked,
                dataValidation: document.getElementById('dataValidation').checked
            };
            
            console.log('[v0] Generating test code for:', selectedTicket.key);
            console.log('[v0] Language:', language);
            console.log('[v0] Test scenarios:', testScenarios);
            
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            try {
                const requestBody = {
                    jiraTicket: selectedTicket,
                    language: language,
                    testScenarios: testScenarios
                };
                
                console.log('[v0] Request body:', requestBody);
                
                const response = await fetch('/api/test-generation/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('[v0] Generate response status:', response.status);
                console.log('[v0] Generate response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('[v0] Generate error JSON:', errorData);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (parseError) {
                        console.error('[v0] Could not parse error as JSON, trying text');
                        try {
                            const errorText = await response.text();
                            console.error('[v0] Generate error text:', errorText);
                            errorMessage = errorText || errorMessage;
                        } catch (textError) {
                            console.error('[v0] Could not parse error as text either');
                        }
                    }
                    throw new Error(errorMessage);
                }

                let generatedProject;
                try {
                    generatedProject = await response.json();
                    console.log('[v0] Generated project received:', generatedProject);
                } catch (parseError) {
                    console.error('[v0] Could not parse success response as JSON:', parseError);
                    throw new Error('Invalid response format from server');
                }
                
                if (!generatedProject) {
                    throw new Error('No project data received from server');
                }
                
                if (!generatedProject.files || typeof generatedProject.files !== 'object') {
                    console.error('[v0] Invalid project structure:', generatedProject);
                    throw new Error('Invalid project structure: missing or invalid files');
                }
                
                const fileCount = Object.keys(generatedProject.files).length;
                if (fileCount === 0) {
                    throw new Error('No files generated in project');
                }
                
                console.log('[v0] Project validation passed. Files:', fileCount);
                
                // Store the generated project globally
                window.generatedProject = generatedProject;
                
                displayProjectPreview(generatedProject);
                
                document.getElementById('downloadBtn').classList.remove('hidden');
                document.getElementById('projectPreviewSection').classList.remove('hidden');
                
                alert(`✅ Test project generated successfully!\n\nProject: ${generatedProject.projectName || selectedTicket.key + '-tests'}\nLanguage: ${generatedProject.language || language}\nFiles: ${fileCount}`);
                
            } catch (error) {
                console.error('[v0] Error generating test project:', error);
                const errorMsg = error.message || 'Unknown error occurred';
                alert(`❌ Error generating tests for ${selectedTicket.key}:\n\n${errorMsg}\n\nPlease check the console for more details.`);
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        });

        // Display project preview
        function displayProjectPreview(project) {
            const preview = document.getElementById('projectPreview');
            preview.innerHTML = '';

            const projectInfo = document.createElement('div');
            projectInfo.className = 'mb-4 p-4 bg-gray-50 rounded-md';
            projectInfo.innerHTML = `
                <h3 class="font-semibold text-lg mb-2">Project: ${project.projectName}</h3>
                <p class="text-gray-600">Language: ${project.language}</p>
                <p class="text-gray-600">Files: ${Object.keys(project.files).length}</p>
            `;
            preview.appendChild(projectInfo);

            // Display files
            Object.entries(project.files).forEach(([filename, content]) => {
                const fileCard = document.createElement('div');
                fileCard.className = 'mb-4 border border-gray-200 rounded-lg';
                
                const fileHeader = document.createElement('div');
                fileHeader.className = 'bg-gray-100 px-4 py-2 border-b border-gray-200 cursor-pointer';
                fileHeader.innerHTML = `
                    <span class="font-medium text-gray-800">${filename}</span>
                    <span class="float-right text-gray-500">Click to expand</span>
                `;
                
                const fileContent = document.createElement('div');
                fileContent.className = 'p-4 hidden';
                fileContent.innerHTML = `<pre class="text-sm text-gray-700 overflow-x-auto">${escapeHtml(content)}</pre>`;
                
                fileHeader.addEventListener('click', () => {
                    fileContent.classList.toggle('hidden');
                });
                
                fileCard.appendChild(fileHeader);
                fileCard.appendChild(fileContent);
                preview.appendChild(fileCard);
            });
        }

        // Download project
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            if (!selectedTicket) {
                alert('Please select a JIRA ticket first');
                return;
            }

            const language = document.getElementById('languageSelect').value;
            console.log('[v0] Downloading test project for:', selectedTicket.key);
            
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            try {
                const requestBody = {
                    jiraTicket: selectedTicket,
                    language: language
                };
                
                console.log('[v0] Download request body:', requestBody);
                
                const response = await fetch('/api/test-generation/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('[v0] Download response status:', response.status);
                console.log('[v0] Download response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('[v0] Download error JSON:', errorData);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (parseError) {
                        try {
                            const errorText = await response.text();
                            console.error('[v0] Download error text:', errorText);
                            errorMessage = errorText || errorMessage;
                        } catch (textError) {
                            console.error('[v0] Could not parse download error');
                        }
                    }
                    throw new Error(errorMessage);
                }

                const blob = await response.blob();
                console.log('[v0] Downloaded blob size:', blob.size, 'bytes');
                
                if (blob.size === 0) {
                    throw new Error('Downloaded file is empty');
                }
                
                const filename = `${selectedTicket.key}-${language}-tests.zip`;
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);
                
                console.log('[v0] Download completed successfully:', filename);
                alert(`✅ Download completed!\n\nFile: ${filename}\nSize: ${(blob.size / 1024).toFixed(1)} KB`);
                
            } catch (error) {
                console.error('[v0] Error downloading test project:', error);
                const errorMsg = error.message || 'Unknown download error occurred';
                alert(`❌ Error downloading test project:\n\n${errorMsg}\n\nPlease check the console for more details.`);
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        });

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
